services:

# Building the simple_calculator server depends on images from NVIDIA's registry
# You'll need to log in first, and have your NVIDIA API key ready.
# Commands as follows:
# docker login nvcr.io
# When prompted:
# Username: $oauthtoken
# Password: <nvapi-your_actual_api_key_here>
# Note: the username really is $oauthtoken (no need to change). The password is your NVIDIA API key.
  aiq-server:
    build:
      context: ../NeMo-Agent-Toolkit  # Point to the sibling directory
      dockerfile: examples/basic/functions/simple_calculator/Dockerfile
    container_name: aiq-calculator-server
    ports:
      - "8000:8000"
      - "6006:6006"  # Phoenix telemetry service
    environment:
      - NVIDIA_API_KEY=${NVIDIA_API_KEY}
    networks:
      - aiq-network
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8000/docs\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  aiq-ui:
    build:
      context: .  # Current directory (NeMo-Agent-Toolkit-UI)
      dockerfile: Dockerfile
    container_name: aiq-ui
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_WORKFLOW=AIQ Toolkit
      - NEXT_PUBLIC_HTTP_CHAT_COMPLETION_URL=http://aiq-server:8000/chat/stream
      - NEXT_PUBLIC_WEBSOCKET_CHAT_COMPLETION_URL=ws://aiq-server:8000/websocket
      - NEXT_PUBLIC_WEB_SOCKET_DEFAULT_ON=false
      - NEXT_PUBLIC_CHAT_HISTORY_DEFAULT_ON=false
      - NEXT_PUBLIC_RIGHT_MENU_OPEN=false
    networks:
      - aiq-network
    depends_on:
      aiq-server:
        condition: service_healthy

networks:
  aiq-network:
    driver: bridge